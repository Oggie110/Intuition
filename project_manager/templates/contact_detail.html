{% extends "base.html" %}

{% block content %}
  <section>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>{{ contact.name or contact.email or "(Unknown Contact)" }}</h1>
        {% if contact.email %}
          <p class="muted">{{ contact.email }}</p>
        {% endif %}
        {% if contact.phone %}
          <p class="muted">{{ contact.phone }}</p>
        {% endif %}
      </div>
      <a href="{{ url_for('list_contacts') }}" style="text-decoration: none;">← Back to Contacts</a>
    </div>
  </section>

  {% if grouped_communications %}
    {% for project_id, data in grouped_communications.items() %}
      <section>
        <h2>
          <a href="{{ url_for('project_detail', project_id=data.project.id) }}" style="text-decoration: none; color: inherit;">
            {{ data.project.name }}
          </a>
        </h2>
        {% if data.project.description %}
          <p class="muted">{{ data.project.description }}</p>
        {% endif %}

        <div class="card" style="margin-top: 1rem;">
          <h3 style="margin-bottom: 1rem;">Communications ({{ data.communications|length }})</h3>

          {% for comm in data.communications %}
            <div style="{% if selected_comm_id == comm.id %}background-color: #f0f0f0;{% endif %} padding: 1rem; border-bottom: 1px solid var(--border); margin: 0 -1.5rem; padding-left: 1.5rem; padding-right: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <div style="flex: 1;">
                  <span class="badge">{{ comm.type }}</span>

                  {% if comm.type == 'email' %}
                    <a href="{{ url_for('contact_detail', contact_id=contact.id, comm_id=comm.id) }}" style="text-decoration: none; color: inherit;">
                      <strong>{{ comm.subject or "(no subject)" }}</strong>
                    </a>
                  {% else %}
                    <strong>{{ comm.subject or "Communication" }}</strong>
                  {% endif %}
                </div>
                <small class="muted">{{ comm.timestamp or "Unknown date" }}</small>
              </div>

              {% if comm.snippet and selected_comm_id != comm.id %}
                <p class="muted" style="margin: 0.5rem 0 0;">{{ comm.snippet[:200] }}{% if comm.snippet|length > 200 %}...{% endif %}</p>
              {% endif %}

              {% if selected_comm_id == comm.id %}
                <div style="margin-top: 1rem; background-color: white; padding: 1rem; border-radius: 0.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0;">Full Content</h4>
                    <a href="{{ url_for('contact_detail', contact_id=contact.id) }}" style="text-decoration: none;">✕ Close</a>
                  </div>
                  <hr style="margin: 0.5rem 0 1rem;">

                  {% if comm_content %}
                    {% if content_type == 'html' %}
                      <div style="max-height: 600px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; border-radius: 0.5rem;">
                        {{ comm_content|safe }}
                      </div>
                    {% else %}
                      <pre style="white-space: pre-wrap; font-family: monospace; max-height: 500px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; border-radius: 0.5rem; margin: 0;">{{ comm_content }}</pre>
                    {% endif %}
                  {% else %}
                    <p class="muted">Content not available.</p>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  {% else %}
    <section>
      <p class="muted">No communications with this contact yet.</p>
    </section>
  {% endif %}
{% endblock %}
