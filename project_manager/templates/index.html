{% extends "base.html" %}

{% block content %}
  <section class="card">
    <h2>Ingest new emails</h2>

    <form action="{{ url_for('fetch_emails') }}" method="post" style="margin-bottom: 1.5em;">
      <div class="field-group">
        <input type="number" name="max" value="10" min="1" max="50" style="width: 80px;">
        <button type="submit">Fetch from Gmail/Apple Mail</button>
      </div>
      <p class="muted">Auto-fetch unread emails from configured sources (Gmail, Apple Mail).</p>
    </form>

    <form action="{{ url_for('ingest_email') }}" method="post" enctype="multipart/form-data">
      <div class="field-group">
        <input type="file" name="email_file" accept=".eml" required>
        <button type="submit" class="secondary">Upload .eml file</button>
      </div>
      <p class="muted">Or manually upload a forwarded <code>.eml</code> file.</p>
    </form>
  </section>

  <section>
    <h2>Pending triage</h2>
    {% if emails %}
      <div class="email-list">
        {% for email in emails %}
          {% set remind_dt = email.remind_at|parse_iso %}
          <article class="card">
            <div class="badges">
              <span class="badge">{{ email.status }}</span>
              {% if email.status == 'snoozed' %}
                <span class="badge {% if remind_dt and remind_dt <= now %}warning{% endif %}">
                  Snoozed until {{ remind_dt.strftime('%Y-%m-%d %H:%M') if remind_dt else 'later' }}
                </span>
              {% endif %}
              {% if email.project_id %}
                <span class="badge">Project #{{ email.project_id }}</span>
              {% endif %}
            </div>
            <h3>{{ email.subject or '(no subject)' }}</h3>
            <p class="muted">
              From {{ email.sender or 'Unknown sender' }}
              {% if email.received_at %} Â· received {{ email.received_at }}{% endif %}
            </p>
            {% if email.snippet %}
              <p>{{ email.snippet }}</p>
            {% endif %}

            <div class="actions">
              {% if projects %}
                <form action="{{ url_for('assign_email', email_id=email.id) }}" method="post">
                  <div class="field-group">
                    <label class="muted" for="project-{{ email.id }}">Assign to</label>
                    <select id="project-{{ email.id }}" name="project_id" required>
                      <option value="" selected disabled>Choose project</option>
                      {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                      {% endfor %}
                    </select>
                    <button type="submit">Assign</button>
                  </div>
                </form>
              {% endif %}

              <form action="{{ url_for('create_project_for_email', email_id=email.id) }}" method="post">
                <div class="field-group">
                  <input type="text" name="name" placeholder="New project name" required>
                  <button type="submit" class="secondary">Create & assign</button>
                </div>
              </form>

              <form action="{{ url_for('snooze_email', email_id=email.id) }}" method="post">
                <div class="field-group">
                  <label class="muted" for="snooze-{{ email.id }}">Decide later</label>
                  <select id="snooze-{{ email.id }}" name="interval" required>
                    <option value="" disabled selected>Snooze</option>
                    {% for key, option in REMINDER_OFFSETS.items() %}
                      <option value="{{ key }}">Remind {{ option[0] }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="secondary">Snooze</button>
                </div>
              </form>

              <form action="{{ url_for('ignore_email', email_id=email.id) }}" method="post">
                <button type="submit" class="danger">Ignore this sender</button>
              </form>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No emails are waiting for a decision. Upload one to get started.</p>
    {% endif %}
  </section>
{% endblock %}
